---
title: "Predicting Pitch Types for 2024 MLB Season"
author: "Alex Rintamaa"
date: "2024-10-12"
output:
  pdf_document:
    latex_engine: pdflatex
header-includes:
  - \usepackage[T1]{fontenc}
  - \usepackage[scaled=0.92]{helvet}
  - \renewcommand{\familydefault}{\sfdefault}
  - \usepackage{parskip}  # Add this line for paragraph indentation and spacing
  - \usepackage{indentfirst}
  - \setlength{\parskip}{0pt}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```
\setlength{\parskip}{0pt}
\setlength{\parindent}{20pt}


# Abstract
*This report analyzes hitting data from 2021 to 2023 to predict the types of pitches hitters will encounter in 2024 MLB season. The pitch types are categorized into three main groups: Breaking Balls, Fastballs, and Off-speed pitches. Using a Random Forest model, known for its robustness in handling large data sets and multiclass predictions, I achieved a prediction accuracy of 59.9%. Results indicate that hitters are likely to see Fastballs approximately 60% of the time, while the proportions of Breaking Balls and Off-speed pitches will vary vary by batter. This highlights the importance of pitch recognition for hitters, as they seek every advantage at the plate.*


\newpage
# 1. Introduction

The unique characteristics of MLB allow for advanced analytical tools to effectively change how baseball is played. Each matchup between a pitcher and batter resembles a chess match, with pitches concealing their pitch intentions while hitters prepare for any possible delivery. While extensive research has focused on optimal pitch selection based on hitters' tendencies, less attention has been given to predicting what pitches hitters should expect to see. This report aims to address that gap with a robust model capable of multiclass predictions. Unlike many professional sports, MLB does not have salary cap restrictions, making it crucial for smaller-market teams to stay ahead of trends. Anticipating pitch types can fundamentally alter how both pitching and hitting are approached. Recent changes aimed at speeding up the game, such as the implementation of the pitch clock and PitchCom, underscore the need for teams to adapt quickly using data-driven predictions.

```{r}
library(dplyr)
library(caret)
library(randomForest)
library(data.table)
library(tidyverse)
library(ggplot2)
library(nnet)
library(class)
library(e1071)
library(doParallel)
library(kableExtra)
```

# 2. Methods

## 2.1 Data Preprocessing & Exploratory Analysis

The dataset comprises over 1,200,000 pitched balls to batters who faced atleast 1,000 pitches between 2021 and 2023. It includes 56 variables representing various aspects of th game at the time of each at-bat. Key variables include: 

- **PITCH_TYPE** Type of pitch thrown
- **BATTER_ID** Unique Identifier for the batter
- **PITCHER_ID** Unique Identifier for the pitcher
- **BALLS** Number of balls in the count
- **STRIKES** Number of strikes in the count
- **INNING** Game inning
- **INNING_TOPBOT** Top or bottom of inning
- **BAT_SIDE** Right-handed or left-handed batter
- **THROW_SIDE** Right-handed or left-handed pitcher
- **ZONE** Specific area of strike zone
- **PLATE_X** Horizontal movement of the pitch
- **PLATE_Z** Vertical movement of the pitch

Pitches lacking a specified type were removed from the dataset, as they could not be classified as Fastball, Breaking Ball, or Off-speed. To classify pitch types consistently, I created a scatter plot (Figure 1) displaying the average horizontal and vertical movements of each pitch type.

### Figure 1: Average Pitch Movement by Pitch Type (2021-2023)
\setlength{\parindent}{0pt}

```{r, fig.fullwidth = TRUE, fig.height=3.75}
# Reading in the data
data <- read.csv("data.csv")

# setting seed for reproducibility
set.seed(10122024)

# Filter out all pitch types that were unknown/unlabeled
data <- data %>%
  filter(PITCH_TYPE != "")

# taking the average horizontal and vertical movement to be used in creating grouping classifications
avg_movement <- data %>% 
  group_by(PITCH_TYPE) %>%
  summarize(avg_plate_x = mean(PLATE_X, na.rm = TRUE),
            avg_plate_z = mean(PLATE_Z, na.rm = TRUE))

# creating a ggplot to show the average vertical and horizontal movement which will be used to make groupings of pitch type
ggplot(avg_movement, aes(x = avg_plate_x, y = avg_plate_z, label = PITCH_TYPE)) + # labeling by each unique pitch type
  geom_point(alpha = 0.7, size = 4, color = "red") + # size, shape and color of each point
  geom_text(vjust = -0.5, hjust = 0.5) + # setting position for the labels
  labs(title = "",
       x = "Average Horizontal Movement (Plate X)",
       y = "Average Vertical Movement (Plate Z)") +
  theme_minimal()
```

Fig. 1 displays 17 different pitch types that were seen from 2021 - 2023. For putting each pitch type into their pitch group, vertical and horizontal movement and the speed at which the pitch has historically been thrown are used as references. Breaking Balls are characterized by high lateral movement (Table 1), while Off-speed pitches typically exhibit lower speeds or significant vertical movement (Table 2). Fastballs include standard varieties such as 4-seam fastballs and sinkers (Table 3).

### Table 1 Breaking Ball Group

```{r}
# Create data frames for each group of pitches
BB_group <- data.frame(
  Pitch_Type = c("FC", "ST", "SL", "SC", "SV"),
  Description = c("Cutter", "Sweeper", "Slider", "Screwball", "Slurve")
)
# table of breaking ball group and preventing it from splitting pages
kable(BB_group, format = "latex", booktabs = TRUE) %>%
  kable_styling(latex_options = "hold_position")
```
\clearpage

### Table 2 Off-speed Group

```{r}
# Create data frames for each group of pitches
OS_group <- data.frame(
  Pitch_Type = c("CH", "PO", "KN", "FO", "EP", "FA", "FS", "CS", "KC", "CU"),
  Description = c("Changeup", "Pitch Out", "Knuckleball", "Forkball", "Euphus", 
                  "Other (FA)", "Split-Finger", "Slow Curve", "Knuckle Curve", "Curveball")
)

# table of off speed group and preventing it from splitting pages
kable(OS_group, format = "latex", booktabs = TRUE) %>%
  kable_styling(latex_options = "hold_position")
```

### Table 3 Fastball Group

```{r}
fastball_group <- data.frame(
  Pitch_Type = c("FF", "SI"),
  Description = c("4-Seam Fastball", "Sinker")
)

# table of fastball group and preventing it from splitting pages
kable(fastball_group, format = "latex", booktabs = TRUE) %>%
  kable_styling(latex_options = "hold_position")
```

\setlength{\parindent}{20pt}

## 2.2 Modeling & Predicting

I employed a Random Forest model, well-suited for multiclass predictions with large datasets. This model reduces overfitting, which is particularly important given the frequency of Fastballs compared to other pitch types. The model was trained using an 80%-20% split of the dataset, utilizing 80% of the pitches from 2021-2023 for training.

```{r}
# reclassifying all of the pitches into there grouped pitch type
data$PITCH_TYPE <- with(data,
                                    ifelse(PITCH_TYPE %in% c('FF', 'SI'), "Fastball",
                                    ifelse(PITCH_TYPE %in% c('SL', 'FC', 'SV', 'SC', 'ST'), "Breaking Ball",
                                    ifelse(PITCH_TYPE %in% c('CH', 'PO', 'KN', 'EP', 'FO', 'FA', 'FS',  'CS', 'KC', 'CU'), "Off-speed", NA))))

```



```{r}
# Selecting the variables to be used in the model
data <- data %>% 
  filter(!is.na(PITCH_TYPE)) %>% # filtering out all NA's in the pitch type
  select(PITCH_TYPE, BATTER_ID, PITCHER_ID, BALLS, STRIKES, INNING, INNING_TOPBOT, BAT_SIDE, THROW_SIDE, ZONE, PLATE_X, PLATE_Z, GAME_YEAR)

# making the response variable PITCH_TYPE into a factor 
data$PITCH_TYPE <- as.factor(data$PITCH_TYPE)

# making the variable INNING TOPBOT into a factor 
data$INNING_TOPBOT <- as.factor(data$INNING_TOPBOT)

# omitting all NA's in the data
data <- na.omit(data)

# making the dataframe into a data table
data <- as.data.table(data)

# splitting the data into a training and testing set on a 80-20 ratio and saving the results as an index number
trainIndex <- createDataPartition(data$PITCH_TYPE, p =0.8, list = FALSE)

# creating the training set and testing set using the trainIndex above
train_data <- data[trainIndex, ]
test_data <- data[-trainIndex, ]
```



```{r}
# creating a subset of the full training data to test for the best hyperparameters
sampled_data <- train_data[sample(1:nrow(train_data), size = 70000), ]

# setting the value of a variable train_control to be a 5-fold cross validation
train_control <- trainControl(method = "cv", number = 5)

# setting a list of mtry values for the train function to run against each other
tune_grid <- expand.grid(mtry = c(1, 2, 3, 4, 5, 6, 7))

# running a Random Forest using the train function from the caret library for testing for the best hyperparemters to beused in the final model
rf_tuned <- train(PITCH_TYPE ~ BATTER_ID + PITCHER_ID + BALLS + STRIKES + INNING + INNING_TOPBOT + BAT_SIDE + THROW_SIDE + ZONE + PLATE_X + PLATE_Z, data = sampled_data,
                   method = "rf",
                   trControl = train_control, # 5-fold CV
                   tuneGrid = tune_grid, # Grid of mtry values
                   ntree = 100 # number of trees to be made
                   )

# saving the best mtry value as a variable to be used in final model
best_mtry <- rf_tuned$bestTune$mtry
```

### Figure 2: Correct vs Incorrect Predictions

```{r, fig.fullwidth=TRUE, fig.height=3.25}
# setting the train control method to none as cross validation has already been done.
train_control <- trainControl(method = "none")
# using only the best mtry value
tune_grid <- expand.grid(mtry = best_mtry)

# final model being trained to make predictions on the test set using the best parameters
rf_final <- train(PITCH_TYPE ~ BATTER_ID + PITCHER_ID + BALLS + STRIKES + INNING + INNING_TOPBOT + BAT_SIDE + THROW_SIDE + ZONE + PLATE_X + PLATE_Z, data = train_data,
                  method = "rf",
                  trControl = train_control, # declaring no cross-validation
                  tuneGrid = tune_grid, # using only the best mtry parameter
                  ntree = 100 # number of trees
                  )

# making predictions on the testing data
rfpredictions <- predict(rf_final, newdata = test_data)

# saving the predictions as a data frame
rfpredictions <- as.data.frame(rfpredictions)
# renaming the column to be prediction_pitch_type
colnames(rfpredictions) <- "PREDICTION_PITCH_TYPE"

# combing the predictions to the testing data so that accuracy measures can be found
rfresults <- cbind(test_data, rfpredictions)

# creating a confusion matrix to check the accuracy of the model and any problems in the predictions
rfconfusion_caret <- confusionMatrix(as.factor(rfresults$PREDICTION_PITCH_TYPE), as.factor(rfresults$PITCH_TYPE))


# Create a data frame for correct and incorrect predictions
accuracy_data <- data.frame(
  Category = c("Correct", "Incorrect"),
  Count = c(sum(rfresults$PREDICTION_PITCH_TYPE == rfresults$PITCH_TYPE),
            sum(rfresults$PREDICTION_PITCH_TYPE != rfresults$PITCH_TYPE))
)

# Plot the pie chart
ggplot(accuracy_data, aes(x = "", y = Count, fill = Category)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = c("lightgreen", "red")) +
  theme_void() +
  geom_text(aes(label = paste0(Count, " (", round(Count/sum(Count)*100, 1), "%)")), 
            position = position_stack(vjust = 0.5))
```
Fig. 2 presents the model's accuracy, illustrating the total number of correct predictions in a pie chart format, with green indicating correct predictions and red indicating incorrect ones. Despite challenges in achieving high accuracy due to the datset's complexity, the Random Forest model outperformed other tested models


### Figure 3: Confusion Matrix Heatmap

```{r, fig.fullwidth=TRUE, fig.height=3.25}
# extracting the confusion matrix
conf_matrix <- rfconfusion_caret$table

# converting the confusion matrix into a data frame
conf_matrix_df <- as.data.frame(conf_matrix)

# Plot the confusion matrix as a heatmap using ggplot
ggplot(conf_matrix_df, aes(x = Prediction, y = Reference, fill = Freq)) +
  geom_tile(aes(color = ifelse(Prediction == Reference, "correct", "incorrect")), size = 2) +
  scale_fill_gradient(low = "white", high = "blue") +
  scale_color_manual(values = c("correct" = "black", "incorrect" = "transparent")) +  # Black outline for correct predictions
  geom_text(aes(label = Freq), vjust = 1) +
  theme_minimal() +
  labs(x = "Predicted Pitch Type",
       y = "Actual Pitch Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(color = FALSE)  # Removes the legend for the color outline
```

Fig. 3 displays a confusion matrix, which helps identify correct and incorrect predictions. The diagonal boxes indicate accurate predictions, while off-diagonal boxes represent errors. Notably, Fastballs were predicted were predicted incorrectly more frequently than Breaking Balls or Off-speed pitches, suggesting an area for improvement in model accuracy.
\setlength{\parindent}{20pt}

# Results

To determine the proportions of pitch mixes, we grouped predictions by specific pitch categories for each batter's unique identifier. Each pitch grouping was divided by the total number of pitches expected for that batter in 2024, as shown in Table 4.
\setlength{\parindent}{0pt}

### Table 4: Ten Player Pitch Mix Proportions

```{r}
# getting a count of the total number of pitches grouped by BATTER_ID and Prediction Pitch Type
rfpitch_counts <- rfresults %>%
  group_by(BATTER_ID, PREDICTION_PITCH_TYPE) %>%
  summarise(count = n(), .groups = 'drop') # counting the number of pitches

# reshaping the data to give columns using only the unique names from the prediction type and having separate columns displaying the number of the each pitch type
rfpitch_counts_wide <- rfpitch_counts %>%
  pivot_wider(names_from = PREDICTION_PITCH_TYPE, values_from = count, values_fill = 0)

# summarizing the different total pitch number by player into proportions using the number of each pitch divided by the total number of pitches
rfpitch_counts_wide <- rfpitch_counts_wide %>%
  mutate(total_pitches = Fastball + `Breaking Ball` + `Off-speed`,
         fastball_proportion = Fastball / total_pitches, # proportion of fastballs
         breaking_ball_proportion = `Breaking Ball` / total_pitches, # proportion of breaking balls
         off_speed_proportion = `Off-speed` / total_pitches) # proportion of off speed pitches

# selecting only the columns needed in the final output 
Pitch_mix <- rfpitch_counts_wide %>%
  select(BATTER_ID, fastball_proportion, breaking_ball_proportion, off_speed_proportion)

# grouping the data and selecting only the first of the proportions as when the left_join was used each player was given the same proportion for each of their atbats verses just one atbat, so this gets rid of players names showing up multiple times.
# Also rounding the proportions to the nearest thousandth for easy to read purposes.
Pitch_mix <- Pitch_mix %>%
  group_by(BATTER_ID) %>% 
  summarize(
    PITCH_TYPE_FB = round(first(fastball_proportion), 3), # rounding fastball
    PITCH_TYPE_BB = round(first(breaking_ball_proportion), 3), # rounding breaking ball
    PITCH_TYPE_OS = round(first(off_speed_proportion), 3), # rounding off-speed
  ) %>%
  ungroup() 

# reordering the columns in the final pitch mix data.
Pitch_mix <- Pitch_mix %>%
  select(BATTER_ID, PITCH_TYPE_FB, PITCH_TYPE_BB, PITCH_TYPE_OS)

# Load the predictions.csv file that contains the BATTER_IDs
predictions_file <- read.csv("predictions.csv")

# dropping the old empty columns
predictions_file <- predictions_file %>%
  select(-PITCH_TYPE_FB, -PITCH_TYPE_BB, -PITCH_TYPE_OS)

# left_join adding in the new pitch mix proportions
final_predictions <- left_join(predictions_file, Pitch_mix, by = "BATTER_ID")

# exporting the final result as a csv file
write.csv(final_predictions, "final_predictions.csv", row.names = FALSE)

# Showing the first 10 results
knitr::kable(head(final_predictions, 10))
```

Table 4 provides the expected pitch percentages for the 2024 season:
 - **PLAYER_TYPE_FB** Percentage of fastballs
 - **PLAYER_TYPE_BB** Percentage of breaking balls
 - **PLAYER_TYPE_OS** Percentage of off-speed pitches
Something important to notice is that the percentage of fastballs for each player is relatively similar; however, the percentage of breaking balls and off-speed changes with a high degree of variability between each batter. For instance, David Peralta is predicted to see a Fastball 63.8% of the time, a Breaking Ball 10.8%, and an Off-speed pitch 25.4%. 

### Table 5 Reds Players Pitch Mix Proportions

```{r}
# selecting specific Reds Players for Visualization
spec_players <- final_predictions %>%
  filter(BATTER_ID %in% c(688715, 663697, 641584, 670770, 682829, 666181))

# table of reds players
knitr::kable(spec_players)
```

Table 5 shows the pitch mix proportions for five players from the Cincinnati Reds. Notably four out of the five players are expected to face Off-speed pitches more frequently than Breaking Balls. This suggests that pitchers may tailor their strategies based on individual batter profiles, a trend further explored in Figure 3.

### Figure 3 Reds Pitch Mix Proportions by Player

```{r}
# converting data to Long Format for ggplot
spec_players_long <- spec_players %>%
  pivot_longer(cols = starts_with("PITCH_TYPE"),
               names_to = "PITCH_TYPE",
               values_to = "proportion")

# creating a plot of pitch type by the selected players
ggplot(spec_players_long, aes(x= PLAYER_NAME, y = proportion, fill = PITCH_TYPE)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Player Name", y = "Proportion") +
  theme_minimal() +
  theme(axis.test.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("PITCH_TYPE_FB" = "blue", "PITCH_TYPE_BB" = "red", "PITCH_TYPE_OS" = "green"))
```

Fig. 3 is a bar graph comparing the expected pitch mixes for each Reds player. Interestingly, left-handed batters such as Will Benson, Jake Fraley, and TJ Friedl, show different expectations compared to right-handed batters like Jonathon India. This indicates the potential for strategic advantages, particularly for switch-hitters like De La Cruz, who can adapt their approach based on pitch type.

\setlength{\parindent}{20pt}

# Discussion

The Primary objective of this report was to use hitting data from 2021 to 2023 to predict the pitch mix proportions that hitters can expect in 2024. Despite the model's overall accuracy being 60%, clear trends emerged, notably that Fastballs are the predominant pitch type. The Analysis reveals the influence of batter handedness of pitch expectations, providing valuable insights for managers and player development staff. While the model indicates potential trends, the accuracy limitations suggest that the proportion of Fastballs may be overstated. Improved processing systems could enhance the model's performance. Overall, this report provides significant insights into the pitch mix proportions hitters should anticipate, offering a strategic advantage for organizations looking to excel in an increasingly data-driven game.
